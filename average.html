<!doctype html>

<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>四段昇段時の平均・中央値（スマホ特化）</title>
<style>
  :root {
    /* 変数は残しています（使われないので表示には影響しません） */
    --bg: #f4e2b8;
    --card: #15171c;
    --text: #1a1a1a;
    --muted: #9aa4b2;
    --accent: #4cc9f0;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  html, body {
    margin: 0;
    padding: 0;
    /* background と color を削除 */
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", Helvetica, Arial, sans-serif;
  }

  .wrap { max-width: 480px; margin: 0 auto; padding: 14px; }
  header { display:flex; align-items:center; gap:10px; margin:4px 0 12px; }
  header .logo { width: 26px; height: 26px; border-radius: 6px; /* background を削除 */ }
  header h1 { font-size: 18px; font-weight: 700; margin: 0; letter-spacing: 0.02em; }

  .card { /* background を削除 */ border: 1px solid #1f232b; border-radius: 14px; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.25); margin-bottom: 12px; }

  .kpi { text-align: center; }
  .kpi .label { /* color を削除 */ font-size: 12px; }
  .kpi .big { font-size: 28px; font-weight: 800; letter-spacing: .02em; margin: 4px 0; }
  .kpi .sub { /* color を削除 */ font-size: 12px; }

  .radio-group { display:flex; justify-content:center; gap:16px; margin-bottom:8px; }
  label { font-size: 14px; }

  .muted { /* color を削除 */ }
  .mono { font-family: var(--mono); }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th, td { border-bottom: 1px solid #232733; padding: 8px 6px; text-align: left; }
  th { /* color を削除 */ font-weight: 700; font-size: 12px; }
  td.num { font-family: var(--mono); text-align: right; }

  /* ここから下の“明るい背景へ上書き”ブロックも、色指定のみ削除 */
  .card, .info-box {
    /* background-color を削除 */
    border: 1px solid #d6c89f;
    border-radius: 8px;
  }

  table {
    /* background-color を削除 */
    border-collapse: collapse;
  }
  th, td {
    /* color を削除 */
    border: 1px solid #d6c89f;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <h1><a href="https://ulti-shogi.github.io/mate-shogi/index.html">将棋の殿堂</a></h1>
    </header>

<section class="card" id="avg-card" style="display:block;">
  <div class="kpi">
    <div class="label">将棋棋士の四段昇段時の平均年齢</div>
    <div class="big" id="avg-ymd">— 歳 — ヶ月 — 日</div>
    <div class="sub">平均日数 <span id="avg-days" class="mono">—</span> 日</div>
  </div>
</section>

<section class="card" id="med-card" style="display:none;">
  <div class="kpi">
    <div class="label">将棋棋士の四段昇段年齢の中央値</div>
    <div class="big" id="med-ymd">— 歳 — ヶ月 — 日</div>
    <div class="sub">中央値日数 <span id="med-days" class="mono">—</span> 日</div>
  </div>
</section>

<div class="radio-group">
  <label><input type="radio" name="view" value="avg" checked> 平均年齢</label>
  <label><input type="radio" name="view" value="med"> 中央値</label>
</div>
    
<section class="card" id="note-card">
  <div class="muted" style="font-size:12px; line-height:1.4;">
    <h4>補足情報</h4>
    <p>*現行の奨励会三段リーグ開始から2025年4月1日付で四段に昇段した棋士まで、全163名が対象。</p>
    <p>*2025年10月1日付で四段へと昇段する棋士4名の情報は、当日以降に追加します。</p>
    <p>平均年齢・中央値ともに、1年=365.2425日、1ヶ月=30.436875日として換算しています。</p>
  </div>
</section>

<section class="card" id="meta-card">
  <div class="muted" style="font-size:12px;">件数：<span id="n" class="mono">—</span> 件</div>
</section>

<section class="card">
  <table id="tbl">
    <thead>
      <tr>
        <th>棋士番号</th>
        <th>棋士名</th>
        <th>昇段時の年齢</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

  </div>  <script>
    const CSV_URL = 'average.csv';
    const YEAR_DAYS = 365.2425;
    const MONTH_DAYS = YEAR_DAYS / 12.0;

    function parseCSV(text) {
      const rows = [];
      let cur = '', row = [], inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (ch === '"') {
          if (inQuotes && text[i+1] === '"') { cur += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (ch === ',' && !inQuotes) {
          row.push(cur); cur = '';
        } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
          if (cur !== '' || row.length > 0) { row.push(cur); rows.push(row); }
          if (ch === '\r' && text[i+1] === '\n') i++;
          cur = ''; row = [];
        } else {
          cur += ch;
        }
      }
      if (cur !== '' || row.length > 0) { row.push(cur); rows.push(row); }
      return rows;
    }

    function daysToYMD(days) {
      let y = Math.floor(days / YEAR_DAYS);
      let r = days - y * YEAR_DAYS;
      let m = Math.floor(r / MONTH_DAYS);
      r -= m * MONTH_DAYS;
      let d = Math.round(r);
      if (d >= Math.round(MONTH_DAYS)) { m++; d = 0; }
      if (m >= 12) { y++; m = 0; }
      return { y, m, d };
    }

    function median(arr) {
      if (!arr.length) return NaN;
      const a = [...arr].sort((x, y) => x - y);
      const mid = Math.floor(a.length / 2);
      return a.length % 2 ? a[mid] : (a[mid - 1] + a[mid]) / 2;
    }

    function textNum(v){
      const n = Number(String(v).replace(/[\s,]/g, ''));
      return Number.isFinite(n) ? n : NaN;
    }

    async function main() {
      const res = await fetch(CSV_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('CSV を取得できませんでした');
      const text = await res.text();
      const rows = parseCSV(text);
      const headers = rows[0];
      const body = rows.slice(1).filter(r => r.length === headers.length);

      const idxNo = headers.findIndex(h => h.includes('棋士番号'));
      const idxName = headers.findIndex(h => h.includes('棋士名'));
      const idxAgeS = headers.findIndex(h => h.includes('昇段時の年齢'));
      const idxDays = headers.findIndex(h => h.includes('昇段までの日数'));
      const valid = body.filter(r => Number.isFinite(textNum(r[idxDays])));

      const n = valid.length;
      document.getElementById('n').textContent = n;

      const daysList = valid.map(r => textNum(r[idxDays]));
      const avgDays = daysList.reduce((a,b)=>a+b,0) / n;
      const medDays = median(daysList);

      const A = daysToYMD(avgDays);
      document.getElementById('avg-ymd').textContent = `${A.y}歳${A.m}ヶ月${A.d}日`;
      document.getElementById('avg-days').textContent = (avgDays).toFixed(1);

      const M = daysToYMD(medDays);
      document.getElementById('med-ymd').textContent = `${M.y}歳${M.m}ヶ月${M.d}日`;
      document.getElementById('med-days').textContent = (medDays).toFixed(1);

      valid.sort((a, b) => textNum(a[idxNo]) - textNum(b[idxNo]));
      document.querySelector('#tbl tbody').innerHTML = valid.map(r => `<tr><td class="num">${r[idxNo]}</td><td>${r[idxName]}</td><td>${r[idxAgeS]}</td></tr>`).join('');

      document.querySelectorAll('input[name="view"]').forEach(radio => {
        radio.addEventListener('change', e => {
          document.getElementById('avg-card').style.display = e.target.value === 'avg' ? 'block' : 'none';
          document.getElementById('med-card').style.display = e.target.value === 'med' ? 'block' : 'none';
        });
      });
    }

    main().catch(err => {
      const msg = document.createElement('div');
      msg.style.cssText = 'color:#ffb3b3; padding:10px;';
      msg.textContent = `エラー: ${err.message}`;
      document.querySelector('.wrap').prepend(msg);
    });
  </script></body>
</html>
