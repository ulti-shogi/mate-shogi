<!doctype html>

<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>歴代タイトル獲得数ランキング（スマホ特化）</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <h1>歴代タイトル獲得数ランキング</h1>
    </header><section class="card">
  <table id="tbl">
    <thead>
      <tr>
        <th>順位</th>
        <th>棋士名</th>
        <th>通算</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

  </div>  <script>
    const CSV_URL = 'title.csv';

    function parseCSV(text) {
      const rows = [];
      let cur = '', row = [], inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (ch === '"') {
          if (inQuotes && text[i+1] === '"') { cur += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (ch === ',' && !inQuotes) {
          row.push(cur); cur = '';
        } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
          if (cur !== '' || row.length > 0) { row.push(cur); rows.push(row); }
          if (ch === '\r' && text[i+1] === '\n') i++;
          cur = ''; row = [];
        } else {
          cur += ch;
        }
      }
      if (cur !== '' || row.length > 0) { row.push(cur); rows.push(row); }
      return rows;
    }

    function textNum(v){
      const n = Number(String(v).replace(/[\s,]/g, ''));
      return Number.isFinite(n) ? n : NaN;
    }

    async function main() {
      const res = await fetch(CSV_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('CSV を取得できませんでした');
      const text = await res.text();
      const rows = parseCSV(text);
      if (!rows.length) throw new Error('CSV が空です');

      const headers = rows[0];
      const idxName = headers.findIndex(h => h.includes('棋士名'));
      const idxTotal = headers.findIndex(h => h.includes('通算'));
      if (idxName < 0 || idxTotal < 0) throw new Error('必要な列が見つかりません');

      const body = rows.slice(1).filter(r => r.length === headers.length);
      const valid = body.filter(r => Number.isFinite(textNum(r[idxTotal])));

      // 通算降順ソート
      valid.sort((a, b) => textNum(b[idxTotal]) - textNum(a[idxTotal]));

      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = valid.map((r, i) => `<tr>
        <td class="num">${i+1}</td>
        <td>${r[idxName]}</td>
        <td class="num">${textNum(r[idxTotal])}</td>
      </tr>`).join('');
    }

    main().catch(err => {
      const msg = document.createElement('div');
      msg.style.cssText = 'color:#ffb3b3; padding:10px;';
      msg.textContent = `エラー: ${err.message}`;
      document.querySelector('.wrap').prepend(msg);
    });
  </script></body>
</html>
